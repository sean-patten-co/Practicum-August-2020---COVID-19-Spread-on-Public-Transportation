---
title: "COVID 082020"
author: "Sean L. Patten"
date: "7/26/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("C:/Users/snlpt/Desktop/MSDS 692/datas")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r COVID-Libraries}


library(DataExplorer)
library(xlsx)
library(tidyverse)
library(lmtest)
library(sandwich)
library(plm)
library(reshape2)
library(Bolstad)
library(bdynsys)
library(pglm)

county_data_ <- read.xlsx("C:/Users/snlpt/Desktop/MSDS 692/datas/final_data_assemble08012020.xlsx", sheetName = "Sheet1")

policy_by_countyt <- read.xlsx("C:/Users/snlpt/Desktop/MSDS 692/datas/policy_by_countyt.xlsx", "Sheet1")

panel_final <- read_csv("C:/Users/snlpt/Desktop/MSDS 692/datas/panel_final_08182020.csv")

panel_final <- panel_final %>% na.omit(FIPS)

fill_out_fips <- function(x){
  
  #x<-as.character(urban_area_to_county$FIPS)
  j <- 1
  y <- vector(mode = "character", length = 0)
  
  
  while (j <= length(x)){
    fips_hold <- x[j]
    while (nchar(fips_hold) < 5){
      fips_hold <- paste0("0", x[j])
      
    }
    y[j] <- fips_hold
    j <- j+1
    
  }
  
  y <- as.character(y)
  return(y)
  
}

panel_final$FIPS <- panel_final$FIPS %>% fill_out_fips()
```


```{r COVID-Explore Data, echo=FALSE}

introduce(county_data_)

county_data_ <- county_data_ %>%replace_na(list(CAREALAND = 0, Pass_Miles = 0, U_P_Trips = 0, SRVC_AREA_SQML = 0, SRVC_AREA_POP = 0, V7.cases = 0, V6.cases = 0, V5.cases = 0, V4.cases = 0, V3.cases=0, V2.cases=0, V1.cases=0, V1.rides = 0, V2.rides = 0, V3.rides = 0, V4.rides = 0, Avg_PMiles_Trip = 0))

introduce(county_data_)

plot_intro(county_data_)

plot_missing(county_data_)

count(county_data_)


introduce(panel_final)

plot_intro(panel_final)

plot_missing(panel_final)

count(panel_final)


```

```{r COVID-Process Data Further, echo = FALSE}

county_data_<- mutate(county_data_, Pass_MperT = Pass_Miles/U_P_Trips)
county_data_<- mutate(county_data_, Pop_Dense = POPESTIMATE2018/CAREALAND)
county_data_ <- mutate(county_data_, SRVC_Pop_Dense = POPESTIMATE2018/SRVC_AREA_SQML)

county_data_$Pass_MperT[is.nan(county_data_$Pass_MperT)] <- 0
county_data_$V4.rides[is.nan(county_data_$APR20)] <- 0
county_data_$V3.rides[is.nan(county_data_$MAR20)] <- 0
county_data_$V2.rides[is.nan(county_data_$FEB20)] <- 0
county_data_$V1.rides[is.nan(county_data_$JAN20)] <- 0

county_data_$SRVC_Pop_Dense[is.infinite(county_data_$SRVC_Pop_Dense)] <- 0
county_data_$indexPMPOPEST <- county_data_$Pass_Miles/county_data_$POPESTIMATE2018/(mean(county_data_$Pass_Miles/county_data_$POPESTIMATE2018))

county_data_<- county_data_ %>% mutate(Cases_per_Person_Jun = JUN_C/POPESTIMATE2018)
county_data_ <- county_data_ %>% mutate(Cases_per_Person_May = MAY_C/POPESTIMATE2018)
county_data_ <- county_data_ %>% mutate(Cases_per_Person_Apr = APR_C/POPESTIMATE2018)
county_data_ <- county_data_ %>% mutate(Cases_per_Person_Mar = MAR_C/POPESTIMATE2018)
county_data_ <- county_data_ %>% mutate(Cases_per_Person_Feb = FEB_C/POPESTIMATE2018)
county_data_ <- county_data_ %>% mutate(Cases_per_Person_Jan = JAN_C/POPESTIMATE2018)

scatter_dat <- county_data_[,c("SRVC_AREA_SQML", "SRVC_AREA_POP", "SRVC_Pop_Dense", "Years.of.Potential.Life.Lost.Rate", "U_P_Trips", "Pass_Miles", "Pass_MperT", "Cases_per_Person_Jun", "Cases_per_Person_Mar", "Cases_per_Person_May", "Cases_per_Person_Apr", "indexPMPOPEST", "APR_C", "JAN20", "FEB20", "MAR20", "APR20", "Avg_PMiles_Trip", "Pass_Miles", "U_P_Trips", "POPESTIMATE2018","Cases_per_Person_Feb", "Restaurants")]

plot_scatterplot(scatter_dat, by = "APR_C")

plot_scatterplot(scatter_dat, by = "Cases_per_Person_Apr")

plot_correlation(scatter_dat)

covid_mod1 <- lm(Cases_per_Person_Mar ~ SRVC_Pop_Dense + POPESTIMATE2018 + Avg_PMiles_Trip + Cases_per_Person_Feb +  + Years.of.Potential.Life.Lost.Rate+Restaurants, data=scatter_dat)

summary(covid_mod1)

covid_mod2 <- lm(Cases_per_Person_Apr ~ SRVC_Pop_Dense + POPESTIMATE2018 + Avg_PMiles_Trip + Cases_per_Person_Mar +  + Years.of.Potential.Life.Lost.Rate+Restaurants, data=county_data_)

summary(covid_mod2)

county_data_ <- county_data_ %>% mutate(RperPerson = Restaurants/POPESTIMATE2018) 

plot_correlation(county_data_[,c("Pass_Miles", "U_P_Trips", "Avg_PMiles_Trip", "POPESTIMATE2018", "RperPerson", "Cases_per_Person_Mar")])

testme <- filter(county_data_, MAR_C < 5000)
testme <- filter(testme, SRVC_AREA_SQML < 100000)

covid_mod3 <- lm(Cases_per_Person_Jun ~ SRVC_Pop_Dense + POPESTIMATE2018 + Avg_PMiles_Trip + Cases_per_Person_May + Years.of.Potential.Life.Lost.Rate+Restaurants, data=testme)

summary(covid_mod3)

coeftest(covid_mod3, vcov = vcovHC(covid_mod3, type="HC1"))

plot_correlation(testme[,c("SRVC_Pop_Dense", "POPESTIMATE2018", "Avg_PMiles_Trip", "JAN_C", "FEB_C", "MAR_C", "APR_C", "MAY_C", "JUN_C", "Years.of.Potential.Life.Lost.Rate", "Restaurants", "Cases_per_Person_Jun", "Cases_per_Person_May", "Cases_per_Person_Apr")])

#panel_final <- panel_final %>% rename(months = month)

listpanelnames <- names(panel_final)

plot_correlation(panel_final[c(4:12)], maxcat = 24L)

panel_final$Res_per_Person <- panel_final$Restaurants/panel_final$POPESTIMATE2018

panel_final$Cases_per_Person <- panel_final$cases/panel_final$POPESTIMATE2018

panel_final$Pop_Dense <- panel_final$POPESTIMATE2018/panel_final$CAREALAND

listpanelnames <- names(panel_final)

plot_correlation(panel_final[,listpanelnames[c(4:15)]], maxcat = 24L)

panel_corr <- panel_final[,listpanelnames[c(4:15)]]

#panel_corr <- panel_corr %>% rename(months = variable)

panel_corr$pop_avpm <- panel_corr$POPESTIMATE2018*panel_corr$Avg_PMiles_Trip

plot_correlation(panel_corr[4:13])

plot_intro(panel_corr)

```

```{r Panel Data Analysis, echo = FALSE}

test_modr <- plm(cases ~ Restaurants + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home, data = panel_final, model="random", effect = "time", index = c("FIPS", "months"))

summary(test_modr)

test_mod <- plm(cases ~ FIPS, model="within", effect = "time", index = c("FIPS", "months"), data=panel_final)

summary(test_mod)

is.pbalanced(panel_final)

cases_per_mod <- plm(Cases_per_Person ~ Res_per_Person  + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + POPESTIMATE2018 +  FIPS + days_at_home, data = panel_final, model="random", effect = "time", index = c("FIPS", "months"))

has.intercept(cases_per_mod)

is.pbalanced(cases_per_mod)

pdwtest(cases_per_mod)

summary(cases_per_mod)

panel_percapita <- county_data_[,c("FIPS", "Cases_per_Person_Jan", "Cases_per_Person_Feb", "Cases_per_Person_Mar", "Cases_per_Person_Apr", "Cases_per_Person_May", "Cases_per_Person_Jun", "RperPerson", "Years.of.Potential.Life.Lost.Rate", "Avg_PMiles_Trip", "SRVC_Pop_Dense", "POPESTIMATE2018")]

panel_percapita <- panel_percapita %>% melt("FIPS", c("Cases_per_Person_Jan", "Cases_per_Person_Feb", "Cases_per_Person_Mar", "Cases_per_Person_Apr", "Cases_per_Person_May", "Cases_per_Person_Jun"))

panel_percapita <- panel_percapita%>%rename(months = variable, cases = value)

panel_percapitax <- panel_percapita%>%right_join(county_data_[,c("FIPS", "RperPerson", "indexPMPOPEST", "Years.of.Potential.Life.Lost.Rate", "Avg_PMiles_Trip", "SRVC_Pop_Dense", "POPESTIMATE2018")])

test_capita <- plm(cases ~ RperPerson + indexPMPOPEST + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + SRVC_Pop_Dense + POPESTIMATE2018 + FIPS, data = panel_percapitax, model="random", effect = "time", index = c("FIPS", "months"))

summary(test_capita)

```

```{r Bayes Models, echo = FALSE}

#bayes models

bayes_1<- bayes.lm(formula = Cases_per_Person_Jun ~ Cases_per_Person_Mar + Cases_per_Person_Apr + Cases_per_Person_May + RperPerson + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + SRVC_Pop_Dense + POPESTIMATE2018, data = county_data_)

summary(bayes_1)

bayes_1

bayes_all_ <- bayes.lm(JUN_C ~ MAY_C + APR_C + (APR_C*MAY_C) + Restaurants + POPESTIMATE2018 + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + SRVC_Pop_Dense + POPESTIMATE2018 + Pop_Dense + Pass_Miles + U_P_Trips + days_at_home, data = county_data_)

summary(bayes_all_)

bayes_all_

```


```{r Exploratory Linear Regression, echo = FALSE}

county_data_ <- county_data_ %>% left_join(policy_by_countyt, by = "FIPS")

plot_correlation(county_data_[,c(3:8, 12:20)])

cases_mod <- lm(JUN_C ~ POPESTIMATE2018 + Avg_PMiles_Trip + MAY_C + Years.of.Potential.Life.Lost.Rate + Restaurants + days_at_home + Pop_Dense + U_P_Trips + SRVC_AREA_SQML, data=county_data_)

summary(cases_mod)

coeftest(cases_mod, vcov = vcovHC(cases_mod, type="HC1"))

cases_mod <- lm(MAY_C ~ POPESTIMATE2018 + Avg_PMiles_Trip + APR_C + Years.of.Potential.Life.Lost.Rate + Restaurants + days_at_home + Pop_Dense + U_P_Trips + SRVC_AREA_SQML, data=county_data_)

summary(cases_mod)

coeftest(cases_mod, vcov = vcovHC(cases_mod, type="HC1"))

cases_mod <- lm(APR_C ~ POPESTIMATE2018 + Avg_PMiles_Trip + MAR_C + Years.of.Potential.Life.Lost.Rate + Restaurants + days_at_home + Pop_Dense + U_P_Trips + SRVC_AREA_SQML, data=county_data_)

summary(cases_mod)

coeftest(cases_mod, vcov = vcovHC(cases_mod, type="HC1"))

cases_mod <- lm(JUN_C ~ POPESTIMATE2018 + Avg_PMiles_Trip + MAY_C + Years.of.Potential.Life.Lost.Rate + Restaurants + days_at_home + Pop_Dense + U_P_Trips + SRVC_AREA_SQML, data=county_data_)

summary(cases_mod)

coeftest(cases_mod, vcov = vcovHC(cases_mod, type="HC1"))

cases_mod <- plm(cases ~ POPESTIMATE2018 + Avg_PMiles_Trip + Years.of.Potential.Life.Lost.Rate + Restaurants + days_at_home +  + U_P_Trips + SRVC_AREA_SQML, data = panel_final, model="random", effect = "time", index = c("FIPS", "months"))

summary(cases_mod)

panel_final$Cases_per_Person <- panel_final$cases/panel_final$POPESTIMATE2018

panel_final$Res_per_Person <- panel_final$Restaurants/panel_final$POPESTIMATE2018

cases_per_mod <- lm(Cases_per_Person ~ Res_per_Person  + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + + POPESTIMATE2018 +  FIPS +days_at_home, data = panel_final)


#not working bdy_cases_per_mod <- bdynsys(p_panel_corr, 3, 2, x = p_panel_corr$Years.of.Potential.Life.Lost.Rate, z = p_panel_corr$avg_PMiles_Trip, v = p_panel_corr$days_at_home, data=panel_corr)

# not working summary(bdy_cases_per_mod)

```

```{r Cluster Analysis - Cluster Analysis, echo = FALSE}

#cluster analysis 
#See if there are patterns to the data that allows for clustering, and what those clusters are

library(NbClust)
library(e1071)
library(factoextra)

normalit<-function(m){
  (m - min(m))/(max(m)-min(m))
}

#prepare data

panelf_cluster <- county_data_[,c(2:8, 13:28, 33:40, 42)]

panelf_cluster_norm <- panelf_cluster[,2:32]

panelf_cluster_norm[is.na(panelf_cluster_norm)] <- 0

i <- 0
while(i < ncol(panelf_cluster_norm)){
  i <- i+1
  panelf_cluster_norm[i] <- panelf_cluster_norm[i] %>% normalit()
}

panelf_cluster_norm <- cbind(panelf_cluster_norm, FIPS = panelf_cluster$FIPS)

fviz_nbclust(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], kmeans, method="silhouette")

fviz_nbclust(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], kmeans, method="wss")


covid_cluster_dpm_9 <- kmeans(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], 9)
covid_cluster_dpm_4 <- kmeans(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], 4)
covid_cluster_dpm_7 <- kmeans(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], 7)

covid_cluster_dpm_2 <- kmeans(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense", "days_at_home", "U_P_Trips", "SRVC_AREA_POP", "SRVC_AREA_SQML", "Avg_PMiles_Trip", "Restaurants", "POPESTIMATE2018", "CAREALAND", "YPLLR")], 2)

summary(covid_cluster_dpm_9)
summary(covid_cluster_dpm_7)
summary(covid_cluster_dpm_4)
summary(covid_cluster_dpm_2)

covid_cluster_dpm_4
covid_cluster_dpm_7
covid_cluster_dpm_9
covid_cluster_dpm_2

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col = rainbow(7))
legend(x=.9, y=1, legend = c(1,2,3,4,5,6,7), fill=rainbow(7))

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col=covid_cluster_dpm_4$cluster)
legend(x=.9, y=1, legend = c(1,2,3,4,5,6,7), fill=rainbow(4))

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col=covid_cluster_dpm_2$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense")], col=covid_cluster_dpm_7$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense")], col=covid_cluster_dpm_4$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Pop_Dense")], col=covid_cluster_dpm_2$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "POPESTIMATE2018")], col=covid_cluster_dpm_7$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "POPESTIMATE2018")], col=covid_cluster_dpm_4$cluster)



plot(panelf_cluster_norm[c("Cases_per_Person_Jun", "YPLLR")], col=covid_cluster_dpm_7$cluster)


plot(panelf_cluster_norm[c("Cases_per_Person_Jun", "YPLLR")], col=covid_cluster_dpm_4$cluster)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "days_at_home")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "days_at_home")], col=covid_cluster_dpm_4$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Restaurants")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Restaurants")], col=covid_cluster_dpm_4$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "days_at_home")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "days_at_home")], col=covid_cluster_dpm_4$cluster)
points(covid_cluster_dpm_4$centers[,c("days_at_home", "Restaurants")], col=1:2, pch=8, cex=2)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Restaurants")], col=covid_cluster_dpm_7$cluster)

#four clusters is the most interesting
plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Restaurants")], col=rainbow(4))
legend(x=.9, y=1, legend = c(1,2,3,4), fill=c(1,2,3,4))

#4 clusters is the most interesting
plot(panelf_cluster_norm[,c("days_at_home", "Restaurants")], col=covid_cluster_dpm_4$cluster)
points(covid_cluster_dpm_4$centers[,c("days_at_home", "Restaurants")], col=1:4, pch=8, cex=2)
legend(x=.9, y=1, legend = c(1,2,3,4), fill=c(1,2,3,4))

plot(panelf_cluster_norm[,c("days_at_home", "Restaurants")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("days_at_home", "Restaurants")], col=covid_cluster_dpm_2$cluster)
points(covid_cluster_dpm_4$centers[,c("days_at_home", "Restaurants")], col=1:2, pch=8, cex=2)


plot(panelf_cluster_norm[,c("JUN_C", "Restaurants")], col=covid_cluster_dpm_2$cluster)
points(covid_cluster_dpm_2$centers[,c("Cases_per_Person_Jun", "Restaurants")], col=1:2, pch=8, cex=2)


plot(panelf_cluster_norm[,c("JUN_C", "days_at_home")], col=covid_cluster_dpm_2$cluster)
points(covid_cluster_dpm_2$centers[,c("Cases_per_Person_Jun", "days_at_home")], col=1:2, pch=8, cex=2)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Restaurants")], col=covid_cluster_dpm_2$cluster)
points(covid_cluster_dpm_2$centers[,c("Cases_per_Person_Jun", "Restaurants")], col=1:2, pch=8, cex=2)


plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "days_at_home")], col=covid_cluster_dpm_2$cluster)
points(covid_cluster_dpm_2$centers[,c("Cases_per_Person_Jun", "days_at_home")], col=1:2, pch=8, cex=2)
legend(x=.9, y=1, legend = c(1,2), fill=c(1,2))

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col=covid_cluster_dpm_4$cluster)
legend(x=.9, y=1, legend = c(1,2,3,4), c(1,2,3,4))

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "Avg_PMiles_Trip")], col=covid_cluster_dpm_2$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "U_P_Trips")], col=covid_cluster_dpm_4$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "U_P_Trips")], col=covid_cluster_dpm_7$cluster)

plot(panelf_cluster_norm[,c("Cases_per_Person_Jun", "U_P_Trips")], col=covid_cluster_dpm_2$cluster)

```

Hold for overnight run: pglm(cases ~ RperPerson + indexPMPOPEST + Years.of.Potential.Life.Lost.Rate + Avg_PMiles_Trip + SRVC_Pop_Dense + POPESTIMATE2018 + FIPS, data = panel_percapitax, model="random", effect = "time", family = "poisson", index = c("FIPS", "months"))

Time for Random Forest

```{r Random Forest Analysis, echo=FALSE}

library(randomForest)

panelf_cluster_norm <- rename(panelf_cluster_norm, YPLLR = "Years.of.Potential.Life.Lost.Rate")

panel_final <- rename(panel_final, YPLLR = "Years.of.Potential.Life.Lost.Rate") 

panel_final <- panel_final %>% left_join(panelf_cluster[,c("FIPS","JAN20", "FEB20", "MAR20", "APR20", "JAN_C", "FEB_C", "MAR_C", "APR_C", "MAY_C", "JUN_C")])

set.seed(42)

covid_cases_rf1 <- randomForest( ~ Restaurants + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home + JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense, data = panel_final, ntree = 100, mtry = 10, importance = TRUE)

covid_cases_rf1

varImpPlot(covid_cases_rf1)

covid_cases_rf2 <- randomForest(cases ~ Restaurants   + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home +  JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense + FIPS, data = panel_final, ntree = 1000, mtry = 11, importance = TRUE)

covid_cases_rf2

varImpPlot(covid_cases_rf2)

importance(covid_cases_rf2)

covid_casesper_rf1 <- randomForest(Cases_per_Person ~ Restaurants + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home +  JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense + Res_per_Person, data = panel_final, ntree = 100, mtry = 10, importance = TRUE)

covid_casesper_rf1

varImpPlot(covid_casesper_rf1)

covid_casesper_rf2 <- randomForest(Cases_per_Person ~ Restaurants   + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home +  JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense + Res_per_Person + FIPS, data = panel_final, ntree = 100, mtry = 10, importance = TRUE)

covid_casesper_rf2

varImpPlot(covid_casesper_rf2)

covid_cases_rf3 <- randomForest(Cases_per_Person ~ Restaurants   + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home +  JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense + FIPS + JAN_C + FEB_C + MAR_C + APR_C + MAY_C + JUN_C, data = panel_final, ntree = 100, mtry = 10, importance = TRUE)

covid_cases_rf3

varImpPlot(covid_cases_rf3)

importance(covid_cases_rf3)

covid_cases_rf4 <- randomForest(cases ~ Restaurants   + YPLLR + Avg_PMiles_Trip + POPESTIMATE2018 + days_at_home + JAN20 + FEB20 + MAR20 + APR20 + U_P_Trips + Pop_Dense + JAN_C + FEB_C + MAR_C + APR_C + MAY_C + JUN_C, data = panel_final, ntree = 100, mtry = 10, importance = TRUE)

covid_cases_rf4

varImpPlot(covid_cases_rf4)

importance(covid_cases_rf4)

```
After experimenting with the data it has been determined that while time series is the 'correct' way to analyze this data the series is too narrow to properly do a panel analysis. There are several approaches we could take, but given the lack of time the best analysis will probably be a month by month analysis of cases using GLM. As we look at each month there will hopefully be a 

```{r Poisson Regression, echo=FALSE}

#pbc_holder <- read.xlsx(file = "policy_by_countyt.xlsx", "Sheet1")

#county_data_ <- county_data_ %>% left_join(pbc_holder, by = "FIPS")

test_formula <- formula(X ~ A + B + (A * B) + Years.of.Potential.Life.Lost.Rate +  Restaurants + U_P_Trips + Pop_Dense + POPESTIMATE2018 + Avg_PMiles_Trip + CAREALAND + days_at_home)

X <- county_data_$JUN_C

A <- county_data_$MAY_C

B <- county_data_$APR_C

plot_histogram(log10(county_data_$JUN_C), geom_histogram_args = list(bins = 100L))

cases_June_glm <- glm(test_formula, data = county_data_, family = "poisson")

summary(cases_June_glm)

anova(cases_June_glm, test = "Chisq")

cases_June_lm <- lm(test_formula, data = county_data_, family = "poisson")

summary(cases_June_lm)


X <- county_data_$MAY_C

A <- county_data_$APR_C

B <- county_data_$MAR_C

plot_histogram(log10(county_data_$MAY_C), geom_histogram_args = list(bins = 100L))

cases_May_lm <- lm(test_formula, data = county_data_, family = "poisson")

summary(cases_June_lm)


X <- county_data_$APR_C

A <- county_data_$MAR_C

B <- county_data_$FEB_C

plot_histogram(log10(county_data_$APR_C), geom_histogram_args = list(bins = 100L))

cases_APR_lm <- lm(test_formula, data = county_data_)

summary(cases_APR_lm)



cases_Apr_glm <- glm(test_formula, data = county_data_, family = "poisson")

summary(cases_Apr_glm)

anova(cases_Apr_glm, test = "Chisq")

```